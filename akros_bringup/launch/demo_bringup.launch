<?xml version="1.0"?>
<launch>
    <!-- ARGUMENTS - BRINGUP -->
    <arg name="board" default="false"/>
    <arg name="t265_tf" default="true"/> <!-- if false EKF tf is published-->
    
    <!-- ARGUMENTS - T265 -->
    <arg name="enable_fisheye"  default="false"/>
    
    <!-- ARGUMENTS - TELEOP -->
    <arg name="teleop_ns"   default="teleop"/>
    <arg name="auto_ns"     default="auto"/>
    <arg name="mixer_ns"    default="twist_mixer"/>
    
    <!-- ARGUMENTS - ARDUINO ODOMETRY -->
    <arg name="encoder_odom_frame" default="enc_odom_frame"/>
    <arg name="encoder_pose_frame" default="enc_pose_frame"/>

    <!-- INCLUDE DESCRIPTION LAUNCH FILE -->
    <include file="$(find akros_description)/launch/akros_description.launch"/>
   
    <!-- INCLUDE LIDAR LAUNCH FILE -->
    <include file="$(find akros_bringup)/launch/ldlidar_ld06.launch"/>
    
    <!-- INCLUDE T265 LAUNCH FILE -->
    <include file="$(find akros_bringup)/launch/rs_t265.launch">
        <arg name="enable_fisheye1" value="$(arg enable_fisheye)"/>
        <arg name="enable_fisheye2" value="$(arg enable_fisheye)"/>
        <arg name="publish_odom_tf" value="$(arg t265_tf)"/>
    </include>
    
    <node pkg="robot_localization" type="ekf_localization_node" name="ekf_oakd_enc" clear_params="true">
        <rosparam command="load" file="$(find akros_bringup)/config/t265_ekf_params.yaml" />
        <param name="imu0" value="t265/odom/sample"/>
        <param name="publish_tf" value="false" if="$(arg t265_tf)"/>
    </node>
    
    <!-- LAUNCH ROBOT_LOCALIZATION NODE (T265 + ENCODER)-->
    <group unless="$(arg t265_tf)">
        
        <!-- node pkg="robot_pose_ekf" type="robot_pose_ekf" name="robot_pose_ekf">
            <param name="output_frame" value="$(arg encoder_odom_frame)"/>
            <param name="freq" value="30.0"/>
            <param name="sensor_timeout" value="1.0"/>
            <param name="odom_used" value="true"/>
            <param name="imu_used" value="true"/>
            <param name="vo_used" value="false"/>
            <param name="debug" value="false"/>
            <param name="self_diagnose" value="false"/>
            <remap from="imu_data" to="/oakd/imu"/>
            <remap from="/robot_pose_ekf/odom_combined" to="enc/odom/filtered"/>
        </node -->
    </group>
    
    <!-- LAUNCH TWIST_MIXER NODE -->
    <node pkg="akros_bringup" type="twist_mixer.py" name="twist_mixer">
        <remap from="teleop_cmd_vel"    to="$(arg teleop_ns)/cmd_vel" />
        <remap from="auto_cmd_vel"      to="$(arg auto_ns)/cmd_vel" />
        <remap from="mode"              to="$(arg teleop_ns)/mode"/>
        <remap from="cmd_vel"           to="$(arg mixer_ns)/cmd_vel"/>
    </node>
    
    <!-- LAUNCH TWIST_MUX NODE (ESTOP) -->
    <node pkg="twist_mux" type="twist_mux" name="twist_mux">
        <rosparam file="$(find akros_bringup)/config/twist_mux_config.yaml" command="load" />
        <remap from="cmd_vel_out" to="/cmd_vel"/>
    </node>
    
    <!-- INCLUDE ROSSERIAL ARDUINO LAUNCH FILE -->
    <include file="$(find akros_bringup)/launch/rosserial_arduino.launch">
        <arg name="odom_frame_id" value="$(arg encoder_odom_frame)"/>
        <arg name="pose_frame_id" value="$(arg encoder_pose_frame)"/>
    </include>
    
    <!-- INCLUDE DS4 CONTROLLER LAUNCH FILE -->
    <include file="$(find akros_teleop)/launch/ds4_drive.launch">
        <arg name="standalone" value="false"/>
    </include>
    
    <!-- LAUNCH ROSBOARD -->
    <group if="$(arg board)">
        <node pkg="rosboard" type="rosboard_node" name="rosboard"/>
    </group>

</launch>
